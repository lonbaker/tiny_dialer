#!/usr/bin/env ruby

require_relative '../options'
require_relative '../lib/tiny_dialer'
require TinyDialer::MODEL_ROOT/:init
require TinyDialer::LIBROOT/:tiny_dialer/:hopper
require TinyDialer::LIBROOT/:tiny_dialer/:dialer
require "eventmachine"
require "fsr"
require "fsr/command_socket"
FSR.load_all_commands
require "tiny_dialer/tcc_helper"

module TinyDialer
  class DialManager
    attr_reader :hopper, :host, :pass, :max_dials

    def initialize(o = {:dialers => 1, :host => '127.0.0.1', :pass => 'ClueCon'})
      @host         = o[:host] || '127.0.0.1'
      @pass         = o[:pass] || 'ClueCon'
      @proxy_server = o[:proxy_server] || '127.0.0.1'
      @max_dials    = o[:max_dials] || 20

      TinyDialer::Log.info "DialManager initialized with #{max_dials} dialers"

      @hopper = TinyDialer::Hopper.create(:max_size => 100)
      @dialer = TinyDialer::Dialer.new(
        host: @host,
        pass: @pass,
        hopper: @hopper,
        proxy_server: @proxy_server
      )

      @interval = 5
      EM.add_timer(@interval, method(:timer_tick))
    end

    def current_dials
      @dialer.es{|e| e.channels.run.select{|ch| ch.dest != "19999" }.size }
    end

    def ready_agents
      TCC_Helper.ready_agents.size
    end

    # how many dials should be made based on current calls and ready agents
    # Never aim for more than max_dials
    def dial_aim
      row = TinyDialer.db[:dialer_pool].first
      ratio = row[:ratio]

      [max_dials, (ready_agents - current_dials) * ratio].min
    end

    def timer_tick
      EM.defer do
        begin
          if dial
            @interval = 0.05
          else
            @interval = [10, @interval * 1.2].min
          end
        rescue Exception => ex
          TinyDialer::Log.error ex
        ensure
          EM.add_timer(@interval, method(:timer_tick))
        end
      end
    end

    def dial
      aim = dial_aim

      if aim < 1
        old = @interval
        @interval = [7, @interval * 1.2].min

        if old == @interval
          return false
        else
          TinyDialer::Log.info "No more leads to load the hopper today"
          return false
        end
      else
        @dialer.dial
      end
    end
  end
end


options = TinyDialer.options.dialer

::EM.run do
  TinyDialer::DialManager.new(
    proxy_server: options.proxy_server,
    max_dials: options.max_dials
  )
end
